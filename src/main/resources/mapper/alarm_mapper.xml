<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="com.erunjrun.main.dao.AlarmDAO">

	<!-- 총 알림 수 -->
	<select id="alarmCount" resultType="int" parameterType="String">
		SELECT COUNT(id) AS alarmCount FROM alarm WHERE id = #{id}
	</select>
	
	<!-- 최근 알림 리스트 (20개) -->
	<select id="alarmList" resultType="com.erunjrun.main.dto.AlarmDTO" parameterType="String">
		SELECT * FROM alarm WHERE id = #{id} AND confirm_use = 'N' ORDER BY create_date DESC LIMIT 0, 20
	</select>
	
	<!-- 크루 권한 알림 -->
	<insert id="crewAdmin" parameterType="com.erunjrun.main.dto.AlarmDTO">
		INSERT INTO alarm(id, code_name, SUBJECT, URL, from_id, content) 
			VALUES(#{id}, #{code_name}, #{subject}, #{url}, #{from_id}, 
			(SELECT crew_name FROM crew WHERE crew_idx = #{idx}))
	</insert>
	
	<!-- 크루 퇴출 알림 -->
	<insert id="crewMemberExpel" parameterType="map">
		INSERT INTO alarm(id, code_name, subject, from_id, content)
			VALUES
			<foreach collection="idList" item="id" separator=",">
				(#{id}, #{code_name}, #{subject}, 
					(SELECT id FROM crew_member WHERE crew_idx = #{idx} AND is_leader = 'Y'), 
					(SELECT crew_name FROM crew WHERE crew_idx = #{idx}))
			</foreach>
	</insert>
	
	<!-- 크루 공지 댓글 알림 -->
	<insert id="crewNoticeComment" parameterType="com.erunjrun.main.dto.AlarmDTO">
		INSERT INTO alarm(code_name, subject, from_id, url, is_url, id, content) 
			VALUES(#{code_name}, #{subject}, #{from_id}, #{url}, #{is_url},
			(SELECT id FROM crew_notice WHERE notice_idx = #{idx}),
			(SELECT subject FROM crew_notice WHERE notice_idx = #{idx}))
	</insert>
</mapper>